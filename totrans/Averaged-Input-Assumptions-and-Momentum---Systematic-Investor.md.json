["```\n\ncreate.ia.averaged <- function(lookbacks, n.lag) {\n\tlookbacks = lookbacks\n\tn.lag = n.lag\n\n\tfunction(hist.returns, index=1:ncol(hist.returns), hist.all)\n\t{\t\n\t\tnperiods = nrow(hist.returns)\n\n\t\ttemp = c()\n\t\tfor (n.lookback in lookbacks) \n\t\t\ttemp = rbind(temp, hist.returns[(nperiods - n.lookback - n.lag + 1):(nperiods - n.lag), ])\n\t\tcreate.ia(temp, index, hist.all)\n\t}\t\n}\n\n```", "```\n\nmomentum.averaged <- function(prices, \n\tlookbacks = c(20,60,120,250) ,\t# length of momentum look back\n\tn.lag = 3\n) {\n\tmomentum = 0 * prices\n\tfor (n.lookback in lookbacks) {\n\t\tpart.mom = mlag(prices, n.lag) / mlag(prices, n.lookback + n.lag) - 1\n\t\tmomentum = momentum + 252 / n.lookback * part.mom\n\t}\n\tmomentum / len(lookbacks)\n}\n\n```", "```\n\n###############################################################################\n# Load Systematic Investor Toolbox (SIT)\n# https://systematicinvestor.wordpress.com/systematic-investor-toolbox/\n###############################################################################\nsetInternet2(TRUE)\ncon = gzcon(url('http://www.systematicportfolio.com/sit.gz', 'rb'))\n    source(con)\nclose(con)\n\n\t#*****************************************************************\n\t# Load historical data\n\t#****************************************************************** \n\tload.packages('quantmod')\n\n\t# 10 funds\n\ttickers = spl('Us.Eq = VTI + VTSMX,\n\tEurpoe.Eq = IEV + FIEUX,\n\tJapan.Eq = EWJ + FJPNX,\n\tEmer.Eq = EEM + VEIEX,\n\tRe = RWX + VNQ + VGSIX,\t\t\n\tCom = DBC + QRAAX,\n\tGold = GLD + SCGDX,\n\tLong.Tr = TLT + VUSTX,\n\tMid.Tr = IEF + VFITX,\n\tShort.Tr = SHY + VFISX') \n\n\tstart.date = 1998\n\n\tdates = paste(start.date,'::',sep='') \n\n\tdata <- new.env()\n\tgetSymbols.extra(tickers, src = 'yahoo', from = '1980-01-01', env = data, set.symbolnames = T, auto.assign = T)\n\t\tfor(i in data$symbolnames) data[[i]] = adjustOHLC(data[[i]], use.Adjusted=T)\n\tbt.prep(data, align='keep.all', dates=paste(start.date-2,':12::',sep=''), fill.gaps = T)\n\n\t#*****************************************************************\n\t# Setup\n\t#****************************************************************** \t\t\n\tprices = data$prices   \n\t\tn = ncol(prices)\n\t\tnperiods = nrow(prices)\n\n\tperiodicity = 'months'\n\tperiod.ends = endpoints(prices, periodicity)\n\t\tperiod.ends = period.ends[period.ends > 0]\n\n\tmax.product.exposure = 0.6\t\n\n\t#*****************************************************************\n\t# Input Assumptions\n\t#****************************************************************** \t\n\tlookback.len = 40\n\tcreate.ia.fn = create.ia\n\n\t# input assumptions are averaged on 20, 40, 60 days using 1 day lag\n\tia.array = c(20,40,60)\n\tavg.create.ia.fn = create.ia.averaged(ia.array, 1)\n\n\t#*****************************************************************\n\t# Momentum\n\t#****************************************************************** \t\n\tuniverse = prices > 0\n\n\tmom.lookback.len = 120\t\n\tmomentum = prices / mlag(prices, mom.lookback.len) - 1\n\tmom.universe = ifna(momentum > 0, F)\n\n\t# momentum is averaged on 20,60,120,250 days using 3 day lag\n\tmom.array = c(20,60,120,250)\t\n\tavg.momentum = momentum.averaged(prices, mom.array, 3)\n\tavgmom.universe = ifna(avg.momentum > 0, F)\n\n\t#*****************************************************************\n\t# Algos\n\t#****************************************************************** \t\n\tmin.risk.fns = list(\n\t\tEW = equal.weight.portfolio,\n\t\tMV = min.var.portfolio,\n\t\tMCE = min.corr.excel.portfolio,\n\n\t\tMV.RSO = rso.portfolio(min.var.portfolio, 3, 100, const.ub = max.product.exposure),\n\t\tMCE.RSO = rso.portfolio(min.corr.excel.portfolio, 3, 100, const.ub = max.product.exposure)\n\t)\n\n\t#*****************************************************************\n\t# Code Strategies\n\t#****************************************************************** \t\nmake.strategy.custom <- function(name, create.ia.fn, lookback.len, universe, env) {\n\tobj = portfolio.allocation.helper(data$prices, \n\t\tperiodicity = periodicity,\n\t\tuniverse = universe,\n\t\tlookback.len = lookback.len,\n\t\tcreate.ia.fn = create.ia.fn,\n\t\tconst.ub = max.product.exposure,\n\t\tmin.risk.fns = min.risk.fns,\n\t\tadjust2positive.definite = F\n\t)\n\tenv[[name]] = create.strategies(obj, data, prefix=paste(name,'.',sep=''))$models\n}\n\n\tmodels <- new.env()\t\n\tmake.strategy.custom('ia.none'        , create.ia.fn    , lookback.len, universe       , models)\n\tmake.strategy.custom('ia.mom'         , create.ia.fn    , lookback.len, mom.universe   , models)\n\tmake.strategy.custom('ia.avg_mom'     , create.ia.fn    , lookback.len, avgmom.universe, models)\n\tmake.strategy.custom('avg_ia.none'    , avg.create.ia.fn, 252         , universe       , models)\n\tmake.strategy.custom('avg_ia.mom'     , avg.create.ia.fn, 252         , mom.universe   , models)\n\tmake.strategy.custom('avg_ia.avg_mom' , avg.create.ia.fn, 252         , avgmom.universe, models)\n\n\t#*****************************************************************\n\t# Create Report\n\t#*****************************************************************\t\t\nstrategy.snapshot.custom <- function(models, n = 0, title = NULL) {\n\tif (n > 0)\n\t\tmodels = models[ as.vector(matrix(1:len(models),ncol=n, byrow=T)) ]\t\n\n\tlayout(1:3)\t\n\tplotbt(models, plotX = T, log = 'y', LeftMargin = 3, main = title)\n\t\tmtext('Cumulative Performance', side = 2, line = 1)\n\tplotbt.strategy.sidebyside(models)\n\tbarplot.with.labels(sapply(models, compute.turnover, data), 'Average Annual Portfolio Turnover', T)\t\n}\n\n\t# basic vs basic + momentum => momentum filter has better results\n\tmodels.final = c(models$ia.none, models$ia.mom)\n\tstrategy.snapshot.custom(models.final, len(min.risk.fns), 'Momentum Filter')\n\n\t# basic vs basic + avg ia => averaged ia reduce turnover\n\tmodels.final = c(models$ia.none, models$avg_ia.none)\n\tstrategy.snapshot.custom(models.final, len(min.risk.fns), 'Averaged Input Assumptions')\n\n\t# basic + momentum vs basic + avg.momentum => mixed results for averaged momentum\n\tmodels.final = c(models$ia.mom, models$ia.avg_mom)\n\tstrategy.snapshot.custom(models.final, len(min.risk.fns), 'Averaged Momentum')\n\n\t# basic + momentum vs avg ia + avg.momentum\n\tmodels.final = c(models$ia.mom, models$avg_ia.avg_mom)\n\tstrategy.snapshot.custom(models.final, len(min.risk.fns), 'Averaged vs Base')\t\n\n```"]