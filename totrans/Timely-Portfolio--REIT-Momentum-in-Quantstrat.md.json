["```\nrequire(quantstrat)\nrequire(PerformanceAnalytics)   # clear out evironment\n# much cleaner thanks to Guy Yollin\nrm(list=ls())\ntry(rm(list=ls(pos=.blotter),pos=.blotter),silent=TRUE)\ntry(rm(list=ls(pos=.strategy),pos=.strategy),silent=TRUE)\ntry(rm(list=ls(pos=.instrument),pos=.instrument),silent=TRUE)   #set up bucketing function to generate signal\nbucket_signal <- function(price,nbuckets,nper) {\n\tmomscore <- price/runMean(price,n=nper)-1\t\n\tbreaks <- quantile(momscore, probs = seq(0, 1, 1/nbuckets),na.rm=TRUE)\n\tbuckets <- cut(momscore, breaks=breaks, labels=FALSE)\n\tsignal <- as.xts(buckets,order.by=index(price))\t\n\tcolnames(signal) <- \"bucket_signal\"\n\tsignal[is.na(signal),1] <- 0\n\tsignal\n}   #get NAREIT data\n#I like NAREIT since I get back to 1971\n#see how to get it in previous post\n#http://timelyportfolio.blogspot.com/2011/06/reits-for-everybody-might-now-mean.html\n#much easier though to get Wilshire REIT since 1977 from FRED\n#also it is daily instead of monthly\n#i'll use this for simplicity\nstock.str <- \"WILLREITIND\"\ngetSymbols(stock.str,src=\"FRED\")\n#get OHLC all filled with monthly closes\nassign(stock.str,to.monthly(get(stock.str)))\nindex(WILLREITIND) <- as.Date(index(WILLREITIND))\n#set up currency and stock\ncurrency('USD')\nstock(stock.str,currency='USD',multiplier=1)\ninitDate='1976-12-31'\ninitEq=coredata(get(stock.str)[1,4])\ntradeSize = 1   #name strategy, account, and portfolio same\nname_all <- \"momBuckets\"\n#set up strategy\nstrat <- strategy(name_all)   #set up portfolio and account\ninitPortf(name=name_all,symbols=stock.str,initDate=initDate)\ninitAcct(name=name_all,portfolios=name_all,initDate=initDate,initEq=initEq)\ninitOrders(portfolio=name_all,initDate=initDate)   #set up indicator\n#do bucket indicator\nstrat <- add.indicator(strategy = strat, name = \"bucket_signal\",\n\targuments=list(price=quote(Cl(mktdata)),nbuckets=5,nper=10),\n\tlabel=\"bucket_signal\")\n#set up signal\nstrat <- add.signal(strategy = strat, name=\"sigThreshold\",\n\targuments = list(threshold=3,column=\"bucket_signal\",\n\trelationship=\"gte\",cross=TRUE),\n\tlabel=\"bucket.gte.3\")\nstrat <- add.signal(strategy = strat, name=\"sigThreshold\",\n\targuments = list(threshold=3,column=\"bucket_signal\",\n\trelationship=\"lt\",cross=TRUE),\n\tlabel=\"bucket.lt.3\")\n#set up rule\nstrat <- add.rule(strategy=strat,name=\"ruleSignal\",\n\targuments = list(sigcol=\"bucket.gte.3\", sigval=TRUE,\n\t ordertype='market',orderqty=tradeSize,\n\t orderside='long', pricemethod='market', replace=FALSE),\n\t type='enter', path.dep=TRUE)\nstrat <- add.rule(strategy=strat,name=\"ruleSignal\",\n\targuments = list(sigcol=\"bucket.lt.3\", sigval=TRUE,\n\t orderqty=\"all\", ordertype='market',\n\t orderside='long', pricemethod='market', replace=FALSE),\n\t type='exit', path.dep=TRUE)   #run strategy and portfolio\nout <- applyStrategy(strategy=strat,portfolios=name_all)\n#break up steps of applyStrategy for debugging\n#strat.ind <- applyIndicators(strategy=strat,mktdata=get(stock.str))\n#strat.sig <- applySignals(strategy=strat,indicators=strat.ind)\n#applyRules(strategy=strat,portfolio=name_all,symbol=stock.str,\n#\tindicators=strat.in,Dates=NULL,signals=strat.sig,mktdata=mktdata,path.dep=TRUE)     updatePortf(Portfolio=name_all,Dates=paste('::',as.Date(Sys.time()),sep=''))\n#analyze performance\nchart.Posn(Portfolio=name_all,Symbol=stock.str)   #unfortunately I do not know yet how to size position\n#on each entry to be CurrentEquity/price\n#so the compare really is not worthwhile\n#this would be the preferred way\n#retCompare <- merge(PortfReturns(Account=name_all)/100,\n#\tROC(get(stock.str)[,4],n=1,type=\"discrete\"))\n#charts.PerformanceSummary(retCompare)     #could do buy/hold comparison similar to\n#blog post A Quantstrat to Build On Part 4\n#but still not really applicable\n#so I will hack this way\n#but of course this really defeats the purpose of quantstrat\npositions <- getPortfolio(name_all)$symbols$WILLREITIND$posPL[,\"Pos.Qty\"]\n#position of 1 will get return and position of 0 will get nothing\nret <- lag(positions,k=1)*ROC(get(stock.str)[,4],n=1,type=\"discrete\")\nretCompare <- merge(ret, ROC(get(stock.str)[,4],n=1,type=\"discrete\"))\ncolnames(retCompare) <- c(\"Strategy\",\"Wilshire REIT\")\ncharts.PerformanceSummary(retCompare,ylog=TRUE, cex.legend=1.25,\n\tmain=\"Wilshire REIT with Aleph Blog Momentum\",\n\tcolorset=c(\"cadetblue\",\"darkolivegreen3\"))\n```"]