["```\n\n############################################################################### \n# Select top N for each period\n############################################################################### \nntop <- function\n(\n\tdata,\t\t# matrix with observations\n\ttopn = 1, \t# top n\n\tdirMaxMin = TRUE\n) \n{\n\tout = data\n\tout[] = NA\n\n\tfor( i in 1:nrow(data) ) {\n\t\tx = coredata(data[i,])\n\t\to = sort.list(x, na.last = TRUE, decreasing = dirMaxMin)\n\t\tindex = which(!is.na(x))\n\t\tx[] = NA\n\n\t\tif(len(index)>0) {\n\t\t\tn = min(topn, len(index))\n\t\t\tx[o[1:n]] = 1/n\n\t\t}\n\t\tout[i,] = x\n\t}\n\tout[is.na(out)] = 0\t\n\treturn( out )\n}\n\n```", "```\n\n############################################################################### \n# Select top N for each period, and keep them till they drop below keepn rank\n############################################################################### \nntop.keep <- function\n(\n\tdata, \t\t# matrix with observations\n\ttopn = 1, \t# top n\n\tkeepn = 1, \t# keep n\n\tdirMaxMin = TRUE\n) \n{\n\tout = data\n\tout[] = NA\n\n\tfor( i in 1:nrow(data) ) {\n\t\tx = coredata(data[i,])\n\t\to = sort.list(x, na.last = TRUE, decreasing = dirMaxMin)\n\t\tindex = which(!is.na(x))\n\t\tx[] = NA\n\n\t\tif(len(index)>0) {\n\t\t\tn = min(topn, len(index))\n\t\t\tx[o[1:n]] = 1\n\n\t\t\t# keepn logic\n\t\t\tif( i>=2 ) {\n\t\t\t\ty = coredata(out[(i-1),])\t# previous period selection\n\t\t\t\tn1 = min(keepn, len(index))\n\t\t\t\ty[-o[1:n1]] = NA\t# remove all not in top keepn\n\n\t\t\t\tindex1 = which(!is.na(y))\n\t\t\t\tif(len(index1)>0) {\n\t\t\t\t\tx[] = NA\n\t\t\t\t\tx[index1] = 1\t# keep old selection\n\n\t\t\t\t\tfor( j in 1:n ) {\n\t\t\t\t\t\tif( sum(x, na.rm = T) == topn ) break\n\t\t\t\t\t\tx[o[j]] = 1\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\t\t\n\t\tout[i,] = x/sum(x, na.rm = T)\t\n\t}\n\tout[is.na(out)] = 0\t\n\treturn( out )\n}\n\n```", "```\n\n# Load Systematic Investor Toolbox (SIT)\nsetInternet2(TRUE)\ncon = gzcon(url('https://github.com/systematicinvestor/SIT/raw/master/sit.gz', 'rb'))\n\tsource(con)\nclose(con)\n\n\t#*****************************************************************\n\t# Load historical data\n\t#****************************************************************** \n\tload.packages('quantmod')\t\n\ttickers = spl('XLY,XLP,XLE,XLF,XLV,XLI,XLB,XLK,XLU,IWB,IWD,IWF,IWM,IWN,IWO,IWP,IWR,IWS,IWV,IWW,IWZ')\t\n\n\tdata <- new.env()\n\tgetSymbols(tickers, src = 'yahoo', from = '1970-01-01', env = data, auto.assign = T)\n\t\tfor(i in ls(data)) data[[i]] = adjustOHLC(data[[i]], use.Adjusted=T)\n\tbt.prep(data, align='keep.all', dates='1970::2011')\n\n\t#*****************************************************************\n\t# Code Strategies\n\t#****************************************************************** \n\tprices = data$prices  \n\tn = len(tickers)  \n\n\t# find month ends\n\tmonth.ends = endpoints(prices, 'months')\n\t\tmonth.ends = month.ends[month.ends > 0]\t\t\n\n\t# Equal Weight\n\tdata$weight[] = NA\n\t\tdata$weight[month.ends,] = ntop(prices, n)[month.ends,]\t\n\t\tcapital = 100000\n\t\tdata$weight[] = (capital / prices) * data$weight\n\tequal.weight = bt.run(data, type='share')\n\n\t# Rank on 6 month return\n\tposition.score = prices / mlag(prices, 126)\t\n\n\t# Select Top 2 funds\n\tdata$weight[] = NA\n\t\tdata$weight[month.ends,] = ntop(position.score[month.ends,], 2)\t\n\t\tcapital = 100000\n\t\tdata$weight[] = (capital / prices) * bt.exrem(data$weight)\t\t\n\ttop2 = bt.run(data, type='share', trade.summary=T)\n\n\t# Seletop Top 2 funds,  and Keep then till they are in 1:6 rank\n\tdata$weight[] = NA\n\t\tdata$weight[month.ends,] = ntop.keep(position.score[month.ends,], 2, 6)\t\n\t\tcapital = 100000\n\t\tdata$weight[] = (capital / prices) * bt.exrem(data$weight)\t\t\n\ttop2.keep6 = bt.run(data, type='share', trade.summary=T)\n\n\t#*****************************************************************\n\t# Create Report\n\t#****************************************************************** \n\tplotbt.custom.report(top2.keep6, top2, equal.weight, trade.summary=T)\n\n```"]