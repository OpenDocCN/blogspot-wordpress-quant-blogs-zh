["```\n\n###############################################################################\n# Load Systematic Investor Toolbox (SIT)\n# https://systematicinvestor.wordpress.com/systematic-investor-toolbox/\n###############################################################################\nsetInternet2(TRUE)\ncon = gzcon(url('http://www.systematicportfolio.com/sit.gz', 'rb'))\n    source(con)\nclose(con)\n\n\t#*****************************************************************\n\t# Load historical data\n\t#****************************************************************** \n\tload.packages('quantmod')\t\n\ttickers = spl('SHY,IEF,TLT,SPY')\n\n\tdata.all <- new.env()\n\tgetSymbols(tickers, src = 'yahoo', from = '1990-01-01', env = data.all, auto.assign = T)\t\n\tfor(i in ls(data.all)) data.all[[i]] = adjustOHLC(data.all[[i]], use.Adjusted=T)\t\t\n\tbt.prep(data.all, align='remove.na')\n\n\tprices = data.all$prices\n\t\tn = ncol(prices)\n\t\tnperiods = nrow(prices)\n\n\t# normalize all prices and plot them\n\tprices = prices/ matrix(first(prices), nr=nperiods, nc=n, byrow=T)\n\tplota.matplot(prices)\n\n```", "```\n\n\t#*****************************************************************\n\t# Load historical data\n\t#****************************************************************** \t\t\n\tdata <- new.env()\n\t\tdata$stock = data.all$SPY\n\t\tdata$bond = data.all$TLT\t\n\tbt.prep(data, align='remove.na')\n\n\t#*****************************************************************\n\t# Code Strategies\n\t#****************************************************************** \n\t# all bonds began trading at 2002-07-31\n\tprices = data$prices\n\t\tn = ncol(prices)\n\t\tnperiods = nrow(prices)\n\n\tmodels = list()\n\n\tperiod.ends = endpoints(prices, 'months')\n\t\tperiod.ends = period.ends[period.ends > 0]\n\n\t#*****************************************************************\n\t# Traditional, Dollar Weighted 40% Bonds & 60% Stock\n\t#****************************************************************** \t\t\t\n\tweight.dollar = matrix(c(0.4, 0.6), nr=nperiods, nc=n, byrow=T)\n\n\tdata$weight[] = NA\n\t\tdata$weight[period.ends,] = weight.dollar[period.ends,]\n\tmodels$dollar.w.60.40 = bt.run.share(data, clean.signal=F)\n\n\t#*****************************************************************\n\t# Risk Weighted 40% Bonds & 60% Stock\n\t#****************************************************************** \t\t\t\t\n\tret.log = bt.apply.matrix(prices, ROC, type='continuous')\n\thist.vol = sqrt(252) * bt.apply.matrix(ret.log, runSD, n = 21)\t\n\tweight.risk = weight.dollar / hist.vol\n\t\tweight.risk = weight.risk / rowSums(weight.risk)\n\n\tdata$weight[] = NA\n\t\tdata$weight[period.ends,] = weight.risk[period.ends,]\n\tmodels$risk.w.60.40 = bt.run.share(data, clean.signal=F)\n\n```", "```\n\n\t#*****************************************************************\n\t# Helper function to adjust portfolio leverage to target given volatility\n\t#****************************************************************** \t\t\t\t\n\ttarget.vol.strategy <- function(model, weight, \n\t\ttarget = 10/100, \n\t\tlookback.len = 21,\n\t\tmax.portfolio.leverage = 100/100) \n\t{\t\n\t\tret.log.model = ROC(model$equity, type='continuous')\n\t\thist.vol.model = sqrt(252) * runSD(ret.log.model, n = lookback.len)\t\n\t\t\thist.vol.model = as.vector(hist.vol.model)\n\n\t\tweight.target = weight * (target / hist.vol.model)\n\n\t\t# limit total leverage\t\t\n\t\trs = rowSums(abs(weight.target))\n\t\tweight.target = weight.target / iif(rs > max.portfolio.leverage, rs/max.portfolio.leverage, 1)\t\t\n\n\t\treturn(weight.target)\t\n\t}\n\n\t#*****************************************************************\n\t# Scale Risk Weighted 40% Bonds & 60% Stock strategy to have 6% volatility\n\t#****************************************************************** \t\t\t\t\n\tdata$weight[] = NA\n\t\tdata$weight[period.ends,] = target.vol.strategy(models$risk.w.60.40,\n\t\t\t\t\t\tweight.risk, 6/100, 21, 100/100)[period.ends,]\n\tmodels$risk.w.60.40.target6 = bt.run.share(data, clean.signal=T)\n\n```", "```\n\n\t#*****************************************************************\n\t# Same, plus invest cash into SHY\n\t#****************************************************************** \t\t\t\t\t\n\tweight = target.vol.strategy(models$risk.w.60.40, weight.risk, 6/100, 21, 100/100)\n\tdata.all$weight[] = NA\n\t\tdata.all$weight$SPY[period.ends,] = weight$stock[period.ends,]\n\t\tdata.all$weight$TLT[period.ends,] = weight$bond[period.ends,]\n\n\t\tcash = 1-rowSums(weight)\n\t\tdata.all$weight$SHY[period.ends,] = cash[period.ends]\n\tmodels$risk.w.60.40.target6.cash = bt.run.share(data.all, clean.signal=T)\n\n\t#*****************************************************************\n\t# Create Report\n\t#****************************************************************** \t\n\tplotbt.strategy.sidebyside(models)\n\n\tplotbt.custom.report.part1(models)\n\n\tplotbt.custom.report.part2(models$risk.w.60.40.target6)\t\t\n\tplotbt.custom.report.part2(models$risk.w.60.40.target6.cash)\t\t\n\n```"]