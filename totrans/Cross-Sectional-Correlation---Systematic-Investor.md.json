["```\n\n###############################################################################\n# Load Systematic Investor Toolbox (SIT)\n# https://systematicinvestor.wordpress.com/systematic-investor-toolbox/\n###############################################################################\ncon = gzcon(url('http://www.systematicportfolio.com/sit.gz', 'rb'))\n    source(con)\nclose(con)\n\n\t#*****************************************************************\n\t# Load historical data\n\t#****************************************************************** \n\tload.packages('quantmod')\t\n\ttickers = sp500.components()$tickers\n\n\tdata <- new.env()\n\tgetSymbols(tickers, src = 'yahoo', from = '1970-01-01', env = data, auto.assign = T)\n\t\tfor(i in ls(data)) data[[i]] = adjustOHLC(data[[i]], use.Adjusted=T)\t\t\n\tbt.prep(data, align='keep.all', dates='1970::')\n\n\tspy = getSymbols('SPY', src = 'yahoo', from = '1970-01-01', auto.assign = F)\n\t\tret.spy = coredata( Cl(spy) / mlag(Cl(spy))-1 )\n\n\t#*****************************************************************\n\t# Code Logic\n\t#****************************************************************** \n\tprices = data$prices['1993:01:29::']  \n\t\tnperiods = nrow(prices)\n\n\tret = prices / mlag(prices) - 1\n\t\tret = coredata(ret)\n\n\t# require at least 100 stocks with prices\n\tindex = which((count(t(prices)) > 100 ))\n\t\tindex = index[-c(1:252)]\n\n\t# average correlation among S&P 500 components\n\tavg.cor = NA * prices[,1]\n\n\t# average correlation between the S&P 500 index (SPX) and its component stocks\n\tavg.cor.spy = NA * prices[,1]\n\n\tfor(i in index) {\n\t\thist = ret[ (i- 252 +1):i, ]\n\t\thist = hist[ , count(hist)==252, drop=F]\n\t\t\tnleft = ncol(hist)\n\n\t\tcorrelation = cor(hist, use='complete.obs',method='pearson')\n\t\tavg.cor[i,] = (sum(correlation) - nleft) / (nleft*(nleft-1))\n\n\t\tavg.cor.spy[i,] = sum(cor(ret.spy[ (i- 252 +1):i, ], hist, use='complete.obs',method='pearson')) / nleft\n\n\t\tif( i %% 100 == 0) cat(i, 'out of', nperiods, '\\n')\n\t}\n\n\t#*****************************************************************\n\t# Create Report\n\t#****************************************************************** \t\t\t\t\n \tsma50 = SMA(Cl(spy), 50)\n \tsma200 = SMA(Cl(spy), 200)\n\n \tcols = col.add.alpha(spl('green,red'),50)\n\tplota.control$col.x.highlight = iif(sma50 > sma200, cols[1], cols[2])\n\thighlight = sma50 > sma200 | sma50 < sma200\n\n\tplota(avg.cor, type='l', ylim=range(avg.cor, avg.cor.spy, na.rm=T), x.highlight = highlight,\n\t\t\tmain='Average 252 day Pairwise Correlation for stocks in SP500')\n\t\tplota.lines(avg.cor.spy, type='l', col='blue')\n\t\tplota.legend('Pairwise Correlation,Correlation with SPY,SPY 50-day SMA > 200-day SMA,SPY 50-day SMA < 200-day SMA', \n\t\tc('black,blue',cols))\n\n```"]