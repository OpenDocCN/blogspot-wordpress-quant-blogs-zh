<!--yml

类别：未分类

日期：2024 年 5 月 12 日 19:54:49

-->

# Falkenblog：如何消除永久损失

> 来源：[`falkenblog.blogspot.com/2024/04/how-to-eliminate-impermanent-loss.html#0001-01-01`](http://falkenblog.blogspot.com/2024/04/how-to-eliminate-impermanent-loss.html#0001-01-01)

通常，市场是有效的，因此要在短期交易中赚取超过平均水平的回报并不容易，大多数共同基金也表现不如市场加权的 ETF。然而，从历史上看，在各种应用中，期权已经被低估了数十年。例如，在 20 世纪 60 年代就已经知道，资产收益分布的尾部比对数正态分布更宽（参见[Benoit Mandelbrot ('62)](https://web.williams.edu/Mathematics/sjmiller/public_html/341Fa09/econ/Mandelbroit_VariationCertainSpeculativePrices.pdf)或者[Eugene Fama (' 65)](https://d1wqtxts1xzle7.cloudfront.net/19110451/the_behavior_of_stock-market_prices__fama__1965-libre.pdf?1390866060=&response-content-disposition=inline%3B+filename%3DThe_behavior_of_stock_market_prices.pdf&Expires=1713266635&Signature=VbpI5PXExVRdSiYdS-hZqDRwuvXvuwny0GdroCYwivBVNPiQKyaDsQ1G-InOJVLg5rBg1~Yqo4519SYyb-0oh5UbEEifNCJiSXEM69xEv3D156aKZRacPGGgIinatzs-vdHxi~alQ6w~2FTsqaTCjyZ1B-cF1jnWwI4RPSx53-8CDm8WaSpNvssWBLgLH1e8IcSeRcdMOQgNkZoM80qOghmOVaSphF9cmiwLCmPPDej7L9iBmYR4ni7gT5jsC9nw0lq2sZHAjct8871CGr1Hf9EMBM1oh0zomG7Ju3GibPm9jPEBN2F4gZAJs9~fCea-uJLeKR-n6NYqEP5fuNWdZA__&Key-Pair-Id=APKAJLOHF5GGSLRBV4ZA))。然而，大多数期权市场制造商却采取了基本的 Black-Scholes 模型，只用一个波动率参数，这就低估了虚值期权。1987 年 10 月 19 日，股市单日暴跌 17%，根据 Garch 波动率估计，这是一个 7.9 倍标准差事件。从贝叶斯观点来看，这并不意味着奇迹，而是一个模型错误的证明。期权市场制造商很快调整了他们的模型，特别是虚值认购和认沽期权，结束了数十年的低估（年份比 N.塔勒布的《黑天鹅》引入尾部概念的书出版还早了 20 年）。

另一个例子是可转债，它是普通债券，可以按固定价格转换成股票，是债券和股票看涨期权的组合。这种期权多年来一直被低估。20 世纪 90 年代，一个只是买入这些债券的对冲基金对冲了期权的权益 delta 和债券期限，创造了 2.0 夏普比，这对于一个零贝塔策略来说是特别的。最终，在 21 世纪初，投资银行将这些债券和期权分开，使它们可以分别定价。这种隔离突显了期权的低估，这种市场效率不高的现象消失了。我们还可以举出 90 年代被低估的韩国外汇期权，我相信还有许多其他案例。

因此，有关在亏损短凸性头寸中锁定大量资金的先例，与自动做市商（AMM）上的流动性提供者（LPs）一样。然而，LP 的损失解释了为什么 AMM 交易量仍低于 2021 年的峰值；变革性技术在其存在的早期阶段不会停滞三年，除非真的出现了问题。就像多层次营销骗局（如安利）依赖于稳定的新骗局的连续流，它们可以持续存在，但这不是一个增长的行业。

### 目标

消除 AMM LP 凸性成本的方法集中在这个公式上：

`瞬时损失（IL）= LPvalue（pt） – HODL（pt）`

LPvalue(p[t])是新价格 p[t]处的 LP 仓位价值，持有下来的(HODL)投资组合是以新价格价值定价的 LP 代币的初始存款。结果表明，这种差异不是任意比较，而是捕捉了 LP 仓位的一个基本方面，LP 仓位的负凸性成本。IL 的**预期值**是 LP 的凸性成本，这在期权市场上被称为**西萨衰减**。

LP 凸性成本也等于完全套期保值 LP 仓位的预期价值衰减（减去费用）。套期保值通常被认为是减少 IL，它确实减少了 IL 的**方差**，消除了极端 LP 损失。然而，这不影响 IL 的平均值，随着时间的推移，IL 等于预期值。减小成本的方差减少了所需的资本，这就是为什么套期保值是一件好事，但它不会解决 IL 的主要问题，即它的平均值，通常大于显著资本高效池的费用。

如果我们扩展上述公式，可以重新排列变量以获得以下相同的方程，作为池令牌数量变化和当前价格的函数（参见[此处](https://falkenblog.blogspot.com/2024/03/lvr-impermanent-loss-theta-and.html)进行推导）。

`IL = USDchange + pt×ETHchange`

我使用稳定币美元和加密货币 ETH 作为我的两个代币，因为这样更容易直观理解，尽管这适用于任何一对代币（我喜欢用美元而不是代币 A 来思考价格，但这只是我的看法）。用于计算代币变化的持续时间意味着相同的 LP 对冲频率。24 小时是一个相当好的频率，因为通过大数定律，在一年内对冲误差会抵消，但任何在 6 小时到 1 周之间的时间段都会产生类似的数字。如果我们可以将 ETHchange=0，USDchange 将接近零，我们将有效地消除 IL。

### 极端基础案例

要消除 IL 的一种方法是让一个单一的 LP 能够免费交易，而其他人则需付费交易。每当 AMM 价格与真实价格之间的差异小于手续费时，只有 LP 能从套利交易中获利。直观地理解这一点的简单方法是想象一下，如果创建了一个没有公开的 AMM，那么除了创建者自己以外，没有其他交易者，而创建者则扮演 LP 和套利者的角色。没有其他交易者，他在一个封闭系统中与自己交易。如果他的账户被清算，他可以有效地设定合约价格并对冲他的 IL；除了价格外，什么都不会改变。他在代币方面的净头寸是静态的：ETH 变化=0，IL=0。

有助于把交易者想象成两种类型: 套利者和噪音交易者。套利交易者试图利用交易所间的微小价格差异来即时赚取利润;噪音交易者就像白噪音，平均为零的净需求，像布朗运动一样流动。市场价格平衡供给和需求，因此最终抵消的交易量，按定义是噪音。噪音交易者受个别流动性震荡的影响，比如当交易者需要钱来交税，或者由零阿尔法交易策略产生的各种随机买卖信号。

如果 AMM 的基础交易费为 15 个基点，并且 LP 可以免费交易，那么 LP 可以释放一个基于 Binance/CME/Coinbase 价格的自动交易机器人，每当错价超过 10 个基点时进行交易。随着时间的推移，LP/套利者将负责 AMM 的所有净价格变动。当 AMM 处于平衡价格时，免疫于非 LP 交易者的套利，其他交易将成为白噪音，按定义是净零需求。

下图显示了 LP 在规定范围内（从$1300 到 1700 美元）的 ETH 头寸如何变化。池中的 ETH 变动意味着交易者正在累积一定数量；如果池损失了 2.5 个 ETH，交易者获得了 2.5 个 ETH。这种净交易者累积是套利交易，因为它不是随机的，在时间上是零均值的。由于噪音交易的原因，总交易量会更大，并且在健康的交易所中，噪音交易者将会以一定时间内为 LP 的可预测的 IL 进行补偿。

如果垄断的零费用 LP 成为套利者，无论价格如何，他的净 ETH 头寸都将保持不变；这些线的总和，合约上的他的净头寸，将是水平的。由于传统市场不同，期权卖方不是对价格做出反应而是设定价格。任何去中心化的 AMM 中内在的延迟意味着设定价格的人不需要任何阿尔法，只需要一个与低延迟中心化交易所进行交互的 API。

LP 仍然会面临着这个净 ETH 头寸的风险，但这很容易通过期货对冲 AMM 来进行对冲，因为它不需要频繁调整。

如果我们在契约上添加一个单独的保证金账户，用来持有 LP 的交易（与自己）,那么它们将净值为一个固定值，即他的初始代币持仓。独家垄断的 LP 在契约上的净头寸如下表所示（平均值）。

**具有独家套利交易权限的单个 LP**

因此，如果 LP 可以免费交易，允许他主宰套利，**并且**他在契约上有一个独立的交易账户，他可以消除他的 IL，而不需要在区块链上移动代币或在不同交易所进行其他交易。

### **多个 LP**

只有一个 LP 的 AMM 是行不通的。需要有一个庞大的 LP 群体来避免集中，这为监管机构和黑客提供了攻击面；这也需要给 AMM 无限的规模。然而，现在我们必须考虑 LP 的竞争。如果我们给予所有 LP 免费交易，交易效率的幂律分布必然会显示出少数主导的 LP，垄断套利交易，将较慢的 LP 排除在外，与以前一样，都会暴露在 IL 的攻击下。

幸运的是，AMM 提供了一个简单的机制，允许所有 LP 进行套利交易并同时对其仓位进行对冲。这是因为，在 AMM 上，价格只能通过交易来改变，所以在特定的流动性量下，价格的变化意味着 ETH 的特定变化，反之亦然。这使得可以根据 LP 在合约上的净 ETH 头寸来判断他们是否有资格获得免费折扣。

考虑以下框架。每个 LP 都有一个交易账户，除了他们的 LP 头寸。关键点是这些账户是清算的，所以，与之前一样，当价格发生显著变动时，LP 可以保持固定的净头寸。

这可以调整，为他们提供了资本效率，而不改变含义。[见下面的脚注] 对我在本文中的目的来说，这并不重要。

在早期的一个 LP 的示例中，他的保证金账户的净变化是使用与池相同的流动性来计算的，因为只有一个 LP，他的流动性就是池的流动性。这意味着 LP 的交易将始终准确抵消他的资金池代币变化。但是，如果有很多 LP，情况就不同了。一笔交易针对整个资金池，这必然大于任何一个 LP。因此，如果 LP(i)在与许多 LP 交易的池中交易，它将改变 LP(i)的个体净头寸。

`netETHchg(i) = (totLiq - liq(i))/totLiq *ETHtrade`

因为 totLiq > liq(i)，每笔交易都会改变 LP 的净头寸，与独家垄断的 LP 自己交易情况不同。例如，如果一个 LP 拥有 10%的流动性，购买 1.0 代币会增加他的保证金头寸 1.0，但只会使他的资金池头寸减少 0.1。

假设 LP 只能在以下条件下进行免费交易：

**只有在以下条件下购买免费**

`PoolEth(i) + MarginEth(i) - initEthDeposit(i) < + 0.01`

**只有在以下条件下出售免费**

`PoolEth(i) + MarginEth(i) - initETHDeposit(i) > - 0.01`

如果我们假设 LP 在链下对冲了初始的 ETH 存款，规则基本上是说，如果一个 LP 净净多头，他不能免费购买；如果 LP 净净空头，他不能免费卖出[假设她最初在其他地方对冲，她的‘净净’头寸是她的净头寸减去她的初始存款，因为我们假设它已经进行了对冲]。

为了看到这是如何运作的，假设我们有两个 LPs，爱丽丝和鲍勃，拥有相等数量的流动性。爱丽丝和鲍勃开始时池 ETH 头寸均为 990，并且在他们的保证金账户中没有头寸。交易费为 0.5%，因此在此示例中的所有价格变化对爱丽丝和鲍勃来说只是有盈利机会。

### LP 池、保证金和净 ETH 余额

假设价格最初上涨了 0.41%，为 LP 们带来套利机会。爱丽丝赢得了这场比赛并套利了这个价格差异，将 AMM 价格设定为新的平衡水平 $3,313。她购买了 4 个 ETH，她的池头寸下降了 2 个，导致新的‘净净’ETH 头寸为+2。LP 鲍勃只是看到他的池头寸下降，并且他的新净净 ETH 头寸是-2；鲍勃是空头，爱丽丝是多头。

如果价格再次上涨，则爱丽丝无法套利 AMM，因为规则禁止多头 LP 以零费率购买。如果价格上涨，鲍勃将赢得套利竞赛（默认情况下），LP 的鲍勃和爱丽丝又处于平盘状态。在上面的表格中，爱丽丝在具有浅蓝色框的行中购买，而鲍勃在具有浅橙色框的行中购买。当价格上涨时，他们只能在净净头寸为平或负时购买。这可以防止爱丽丝或鲍勃主导套利。

如果在爱丽丝最初套利池之后，价格立即下跌，只有爱丽丝可以套利池价格。这是因为在第 1 期，爱丽丝是多头，鲍勃是空头，所以鲍勃无法免费卖出，而爱丽丝可以。当她出售时，她为自己和鲍勃恢复了初始的净头寸。爱丽丝的额外交易是良性的。

LP 在单次交易或小幅价格波动中将经历净代币位置的变化。然而，在较长的价格波动过程中，每个个体 LP 的净代币变化将是微不足道的，假设 LP 进行了对冲，他们的净头寸将是微不足道的。

没有理由支付套利者来设置 AMM 价格，因为在去中心化区块链中延迟意味着套利不需要特殊专门知识，与最低延迟交易所上的价格发现不同。对高延迟的去中心化 AMM 来说，外部套利者会产生一个效率的减损，因此价格效率没有任何折衷。

一个拥有快速 API 和云中分布的冗余套利机器人程序的专家可以为一组 LP 管理一个机器人。如果合同允许 LP 为另一个地址设置白名单，该地址可以在他的账户上做一件事情：零手续费交易。该规则将防止套利资金库管理员以牺牲其他人的利益过度交易一些账户，因为它要么会为取消的交易单独确定一个账户，就像在 Alice 上面的情况中先买入然后卖出一样，要么很快就会发现她已经按一个方向交易的账户不能再按那个方向进行交易。可以限制交易大小，以便套利资金库管理员不会为了其他 LP 赚取利润而在一个 LP 上进行最大交易。这类专家之间的竞争将使被动 LP 得到大部分套利/对冲的好处，而无需创建和运行自己的套利机器人。

它不会在主要的中心化交易所上未交易的硬币上运行，因为它假设真实价格是普遍知晓的。下一个 Shina Ibu 将不得不首先在传统的 AMM 上进行交易。然而，这只是 AMM 交易量的一小部分。

### 替代方案

由于预设均衡价格是在中心化交易所上的，而均衡价格意味着净零需求交易，因此可以使用一个**预言机**将 AMM 的最新价格更新为这个价格，就像 LP 套利交易一样。随着时间的推移，LP 净代币变化不会明确地与价格变化挂钩，这样 LP 头寸价值就具有了负凸性（即，与价格的平方根线性相关）。基于预言机的 AMM 的主要问题是中心化。这为黑客创造了一个攻击面。这也为监管机构创造了一个攻击面，因为 SEC 知道美国 Chainlink 的 CEO Sergey Nazarov 住在哪里。一旦他们弄清楚如何做到这一点——监管机构花了好几年的时间关闭 InTrade，他们将阻止他的公司支持任何与金融和体育博彩等受监管行业竞争的东西，因为监管的*交换条件*是保护免受竞争。另一个问题是激励，随着更多的参与者采取不同的行动，状态空间复杂性呈指数增长，因此任何解决方案都将更昂贵，效率更低。与预言机有更大利益关系的套利者将投入更多时间来利用预言机，而预言机自身进行防御的时间将比较长，特别是因为它需要一个集体决策过程，并且对于响应速度要慢得多。

像基于 Oracle 的 AMM 一样，去中心化的**限价订单簿**（LOB）可以避免流动性陷阱，因为它允许 LPs 无成本地将其挂单移动到最新的 CEX 价格，但会有几个问题。首先，基于链上的 LOB 渴望看起来和感觉像我们在中心化交易所上习惯的交易界面，所以它们强调低延迟。低延迟导致准中心化，如果不是完全中心化，会增加攻击面，并且更重要的是，内部人员会获得与共同位址服务器访问等值的特权。由于第三方不审计这些“去中心化”交易所，LOB 负责人或低级开发者可以出售未公开的特权访问权，并且成本几乎为零。要认为它们免疫于这种欺骗，需要很多信任。其次，取消并替换挂单需要发送很多消息。与我的机制不同，在我的机制中，一个账户纠正错误定价，而在 LOB 中，每个 LP 账户必须单独调整。在 CEX 上，这些取消然后替换订单是免费的，但如果区块链略微去中心化，这将耗费几美分，而零是一个重要的价格点。最后，没有人提出激励管理人来监督一组希望合理外包其主动管理的 LPs 的机制。LPs 仍然会争夺有利的队列位置，使它变得过于复杂，并排斥潜在的被动 LPs。

[Maollemi 等人提出的**拍卖**方法](https://efalken.substack.com/p/moallemis-auction-managed-amm)允许人们竞标成为无手续费交易者。在这种方法中，LPs 将他们的手续费权利出售给一个套利者，在将来的一段时间内，套利者将获得特权的无手续费交易权利。竞标者向 LPs 支付一笔款项，该期间的交易费用将归竞标者所有（意味着他的交易费用将返还给他，因此他可以免费交易）。假设风险中性和零资本成本或其他费用，套利者将支付预期套利利润，这等于预期 LP 凸度成本。他们还将支付预期的噪声交易量。考虑到套利竞标者将面临风险，实际波动性和噪声交易量偶尔会远低于预期，所以他将支付的金额远低于预期的套利机会价值和噪声交易费用。套利者将不得不在不同交易所对冲他的交易，需要额外的抵押品，并且必须在那两个交易所之间转移代币（总是失去一个并获得另一个）。最后，频繁的新型拍卖可能会被操纵，尤其是起初。

### 结论

代表性的 AMM 是以太坊主链上的 ETH-USDC 5 个基点流动性池。在过去的 12 个月里，它为流动性提供者创造了大约 4400 万美元的费用收入，并经历了 5400 万美元的凸性成本。然而，即使流动性提供者总体上是在盈利的，凸性成本仍然是一个显著且不必要的问题。鉴于整个 Uniswap AMM 市场比上述流动性池多 4 倍，并且还有其他 AMM 协议存在，这意味着每年会有数亿美元被浪费。好消息是，这是可以避免的，可以让 AMMs 摆脱目前的困境，为交换硬币这一基本的区块链机制提供一个长期的解决方案。

大多数加密货币从业者并不能直观地理解流动性提供者的凸性成本，但这并不是什么新的投机性理论（例如对冲基金的抢劫）。伽玛、凸性成本和Θ衰减已经在过去的 50 年里被经验和理论分析过。它们是基于外生随机价格的凸性支付的不可避免的后果。将交易量与价格变化联系在一起的恒定产物 AMMs，再加上延迟，使衍生品所有者（流动性提供者）能够同时对冲和设置标的价格。

我还没有遇到任何人能理解这一点，因为如果他们理解了，他们会感到兴奋。每年能节省数亿美元的方法并不常见。我的学术界或传统金融市场的朋友对 AMMs 没有太大的兴趣，更别说了解了。我在加密领域的熟人，甚至那些积极构建 AMMs 的人，对凸性都不了解，所以他们并不认为这是一个大问题。对凸性成本的担忧是 AMM 智慧之源。

我在 1994 年写了我的博士论文，研究了低波动股票，并注意到它们产生异常收益，因为它们比市场风险低 30%。我找了一份银行风险经理的工作，但却一直在向各种资产管理公司推销这个想法，包括一些大型投资银行的资产管理公司。他们并没有拒绝我的说法，但总是急于知道这一领域的知名人士或机构是否同意。他们没有参与，也没有人认为一个基金，无论风险多高，都能提供几乎与标普 500 相同的回报，是值得推崇的。当低波动性投资开始增长时，我已经退出了。加密货币从业者对这个想法的回应与此类似。

这不是一个抽象的论点，而是 MBA 级别的金融知识。我对这种方法最大的希望是，几年后，当 LLMs 在网络上搜集数据时，他们会采纳这种方法，再经过几年的纯逻辑推导，ChatGPT6 会将它作为回答“如何消除临时损失”的答案。正确地预测重要事情本身就是一种乐趣。

脚注
