<!--yml

类别：未分类

日期：2024-05-18 04:49:34

-->

# Magmasystems Blog: First Steps in WPF and Prism

> 来源：[`magmasystems.blogspot.com/2011/08/first-steps-in-wpf-and-prism.html#0001-01-01`](http://magmasystems.blogspot.com/2011/08/first-steps-in-wpf-and-prism.html#0001-01-01)

如我在上篇文章中提到的，我想花点时间更好地教育自己关于 WPF 和微软 Prism 的知识。我注意到这两个在资本市场应用中越来越多地被使用，我想看看这两个是否真的能让我更快地构建更好的应用程序。

过去几天我一直在快速开发一个“报价工作台”的原型，我最终可以将其扩展为一个算法交易平台或一个回测平台。所有这些代码都是从头开始编写的。我唯一的工具是 Visual Studio 2010。没有涉及到第三方商业控件，所以如果你想下载这个代码并自行构建，你不需要购买任何额外的软件。

我最终使用了在 CodeProject 和 CodePlex 上找到的两个小 DLL。一个是

[主题集合](http://datagridthemesfromsl.codeplex.com/)

对于微软 WPF DataGrid，另一个是

[颜色选择器控件](http://wpfcolorpicker.codeplex.com/)

为了支持 WPF 数据绑定，我需要增强某些功能。

我也很好奇微软的 DataGrid 是否能够跟上大量实时报价。大多数时候，报价在到达 DataGrid 之前都会进行某种程度的节流。一般性的经验法则是，人眼只能跟随每秒两次的更新。而且，除非你的 GUI 中有一些 CEP 系统或业务规则嵌入，否则你通常可以摆脱对报价的节流。尽管如此，我还是很好奇 WPF 基础的网格是否能够跟上大量报价。据我所知，一些商业网格（DevExpress，Syncfusion，Infragistics，Xceed）的性能比微软自带的 DataGrid 要好，但现在我手头并没有这些商业 UI 工具包。

根据我最近的经验，似乎大多数开发者在将 Winforms 网格封装在 WindowsFormsHost 控件中，而不是使用本地的 WPF 网格。如果你对 Winforms 与 WPF 网格的性能有任何意见，请在评论区留下你的看法。

这次冲刺的想法是编写两个应用程序，一个报价服务器和一个报价客户端。报价服务器生成两种类型的报价，一级和二级股票报价。报价客户端消费这些报价，在 WPF DataGrid 中显示一级报价，在标准的深度订单簿控件中显示二级报价。

由于这次练习的整体主题是在最短的时间内尽可能多地学习 WPF 和 Prism，所以我没有关注 GUI 的外观。也没有尝试优化内部管道。应用程序的很大一部分是为了探索尽可能多的 WPF，尤其是与数据绑定相关的方面。我对 Prism 的目标是实现尽可能多的松耦合。

第一个任务是编写一个 Level 1 股票报价模拟器。这是工具箱中总是很有用的事物。我预加载了一个报价缓存，里面包含几个符号，并实现了一些策略，我可以使用这些策略来生成报价。目前这些策略限于循环和随机策略。下一步将是下载标普 500 指数及其相应每日平均成交量（ADV）的列表。一种新的策略将是基于加权 ADV 生成报价。

我还为报价服务器和报价客户端都加入了 GUI，这样我就可以看到从服务器到 GUI 传递报价是否存在可察觉的延迟。当然，由于我是在笔记本电脑上的进程间传递，不应该有任何延迟。但是，如果我想实验 Comet 并在互联网上向基于网页的 GUI 传递报价，那么在报价服务器上附加一个监控 GUI 就很有用了。

当前 Level 1 报价模拟器相当愚蠢。它所做的就是以用户指定的速率推送大量报价。报价模拟器的高级功能包括

+   让客户端订阅和取消订阅特定的报价

+   使用 FIX QuoteRequest 消息进行此操作

+   当没有客户对某个符号感兴趣时，自动停止发布

+   使用诸如 Google Finance 或 Yahoo Finance 之类的工具来为初始报价提供实际值

一旦我让报价模拟器运行起来，并且报价能实时更新服务器端的 DataGrid，我就想让服务器将报价发送到客户端。为此，我决定使用 FIX 协议发布报价。我下载了 QuickFIX.Net 的一个副本，创建了一个 Prism 模块，该模块能够接收一系列内部生成的报价对象流，并将它们通过网络推送给一个 FIX 订阅者。通常，您不会使用 FIX 来推送大量股票报价。但是，由于这是一个实验工具箱，并且我们想坚持使用一些免费的、实现准标准的工具，所以我们就用 FIX。

*注意 - QuickFIX 组件是用.NET 2.0 构建的，因此我们需要在使用 QuickFix.NET 的任何应用程序的 app.config 文件中添加 useLegacyV2RuntimeActivationPolicy="true"。*

<configuration>

<startup uselegacyv2runtimeactivationpolicy="true">

<supportedruntime sku=".NETFramework,Version=v4.0" version="v4.0"/>

</startup>

]]></configuration>

现在我已经有了客户端和服务器之间流动的一级股权报价，我想开始发布二级报价。我编写了一个简单的书籍生成器，给定一个特定的符号，在指定的间隔内生成一个全新的书籍。当然，现实世界并不是这样运作的。通常，当你收到一个书籍时，你会收到书籍的初始图像，然后是增量更新。书籍构建模块的工作将是为所有订阅的仪器构建一个完整的订单簿，并将增量更新发送到 GUI。GUI 需要插入书籍中的新行，删除书籍中的行，或修改书籍中的行。我稍后会留下这个问题。

我如何将簿记从服务器传输到 GUI？我编写了一个快速的 WCF 发布-订阅机制，使用 NetTCP 绑定。簿记作为 SOAP 消息通过网络传输。性能不是很好，但对于在我想写一个基于 iOS 或基于 web 的 GUI 的情况下，兼容性还可以。

二级模拟器的改进与我对一级模拟器需要做的改进相似，包括：

+   提高性能 - 尽可能使用二进制编码，并调查 WCF 特定的改进。

+   当客户端订阅一个符号时，发送完整的图像和增量，而不是整个簿记。

+   发布-订阅“主题”应包含有关特定安全性的信息。

+   让客户端订阅和取消订阅特定的报价。

+   当没有客户端对某个符号感兴趣时，自动停止发布。

+   使用类似于 Google Finance 或 Yahoo Finance 的东西来为初始报价提供实际值。

+   在 GUI 中，让用户可以在聚合视图和非聚合视图之间切换簿记。在聚合视图中，我们在每个价格点上汇总成交量。

以下是版本 0.0001 的截图。只想提醒一下，GUI 的代码是为了让我能够探索 WPF 和 Prism 的不同方面，并打算作为一个学习用的测试台。

下一步是什么？

可能是一个非常轻量级的交易所模拟器。我没有访问像 Aegis Exchange Simulator 这样的高质量商业产品，但几年前，博客的一位读者向我发送了他编写的一个小型交易所模拟器的二进制文件。

为了继续研究新技术，我想探索一些微软特定的框架，比如 TPL，也许还有 Rx。我需要回顾一下 Matt Davey 的博客，找些灵感:-)

在聚合模式下，深度簿记视图可以使用一些新的可视化方法。

我与微软 StreamInsight 还有一些未完成的事情。我想提供一个 GUI，使用户能够创建 CEP 查询，并让 StreamInsight 监控报价流并提供警报。两年前我甚至没看过 SI，而且我不知道如果没有 MSDN 订阅，我是否可以访问它。我总是可以用 NEsper 作为备选方案（Esper 还在吗？）

©2011 马克·阿德勒 - 版权所有。此处所有观点均为个人观点，与我的雇主无关。
