<!--yml

类别：未分类

日期：2024-05-12 19:56:35

-->

# Falkenblog：从 v2 推导出 Uniswap v3

> 来源：[`falkenblog.blogspot.com/2022/11/deriving-uniswap-v3-from-v2.html#0001-01-01`](http://falkenblog.blogspot.com/2022/11/deriving-uniswap-v3-from-v2.html#0001-01-01)

Uniswap 版本 3（v3）使用受限范围，例如 ETH 的价格范围从 $1000 到 $2000，而在版本 2（v2）中，范围是不受限制的（即从 0 到无穷大）。在 v2 中，LP 提供相等价值的两种代币，而在 v3 中，相对值取决于价格界限和当前价格。LP 可以选择各种称为 ticks 的价格界限。LP 范围由这些 ticks 定义，一个低位和一个高位，界定了 LP 的范围。

**ETH-USDC 0.3% 池的当前 v3 集中范围的汇总**

我将假设在本示例的其余部分中使用一个简单的 ETH/USDC 池，而不是代币 A 和 B。这样更容易解释，并且易于概括。

在任何 ticks 集合中，Uniswap 文档中有一个称为“流动性”的池流动性度量。虽然这个术语有直观的含义，但在恒定产品自动做市商（AMM）的背景下，它有一个具体的定义。

要了解如何实现这一点，请考虑定义在价格 {2500, 2601} 上的 v2 范围，流动性为 1000

**表格 1**

**LP ETH 和 USDC，流动性=1000**

> ETH                USD
> 
> ETH 价格 = 2500        20.00               50,000
> 
> ETH 价格 = 2601        19.61               51,000
> 
> 差异                           0.39                 1,000

流动性比其平方 *k* 更直观，因为它反映了需要多少美元来将价格的平方根移动 1\. 在上述示例中，用 $1000 USDC 兑换 ETH 将价格从 2601 降低到 2500，而购买 $1000 将使价格从 2500 上升到 2601\. 在 v3 中，关键是找到一种方法来复制这种价格和数量的关系，同时不需要 v2 池中的所有资金。

在 v2 中，对于给定数量的流动性，池中的 USDC 随价格不断增加，而 ETH 随价格不断减少。如果 LP 不添加或删除流动性，那么在任何给定价格下，它们的乘积是恒定的，而池仅仅受到交易的影响。以下是一个简单的 ETH/USD 池，在宽范围内（0 到 2500）不受限制的范围内。

**图 1**

尽管 v2 为价格创建了一个非线性函数，但在代表平均每日价格变化的范围内（约为 4%），关系看起来大致线性。如果我们将自己限制在范围 2500 到 2601 内，那么 USDC 的池量从 50000 到 51000，而 ETH 则从 20.00 下降到 19.61。集中范围允许 LP 仅在该范围内提供净交换量，而不是该范围外需要的额外 USD 和 ETH。因此，如果当前价格为 2500，并且 LP 目标范围为 {2500, 2601}，则只需 0.39 ETH。她不需要 USDC，因为她只在当前价格之上提供流动性，不必提供 USDC 来购买；卖方将价格下调并将其推出范围之外，因此该事件与她无关。同样，如果价格为 2601，她只需要提供 $1000 USDC 和零 ETH。

另一种看待这一点的方式是，在 v2 和 v3 中，对于特定的流动性水平的特定刻度，池代币的变化是相同的；但是，这两个合同中的代币量并不相同。在图 2 中，我们可以看到，在两种情况下，USDC 和 ETH 的变化分别为 1000 和 0.39，尽管 v2 需要十倍的总量。

**图 2**

为了让数学运算使用更少的令牌，我们需要找到必要的调整，使得上述图形的斜率相同，因为这代表了在此范围内价格变动所需的 ETH 和 USDC 的数量。让我们称之为 v3 集中范围内的 ETH 量为 ETHv3；这是满足此限制范围内交易者的实际或非负 ETH 量。为了匹配 v2 的数学，我们将称之为“虚拟”ETH，即使数学运算成立所需的 ETH 量。

从标准的 v2 逻辑开始

我们用新的 ETHv3 组件替换 ETHv2

替换后，我们得到

给定

我们可以替换 USD 并得到

重新排列，我们得到

在范围顶部的 v3 LP 所需的 ETH 量为零，因此我们知道：

上述方程意味着对于范围 {2500, 2601}，我们的虚拟 ETH 就是

如果价格超过 2601，Alice 不受影响。这是因为她不再为 USD 提供任何更多的 ETH。这意味着整个价格范围内的 ETH-virtual 是范围顶部价格的函数。所以现在我们采用 v3 相对于 v2 的定义：

给定上述方程，并通过用 pHigh 替换 2601 进行泛化，我们可以解出 Alice 范围内不同价格的 ETHv3

这个公式，从 v2 池数学推导而来，为提供 v3 池上的集中流动性的 LP 提供了所需的会计技巧。

同样，我们可以应用相同的逻辑来获得给定范围内的 USDvirtual 量：

给定上述方程，我们可以计算使 v3 数学运算成立所需的 USDvirtual。这里 USDvirtual 是下限价格的函数。

v3 LP 令牌数量，它们的‘真实’金额，通过常数调整以匹配 v2。作为常数，它们不影响价格变化如何影响范围内 v3 令牌的变化。

**范围外的范围数学**

在范围之外，我们需要替换的事实是范围是不活跃的；它不提供范围之外的流动性。LP 在 2500 及以下的位置有一个简单的位置{ETH=0.31，USDC=0}，在 2601 及以上则有{ETH=0，USDC=$1000}。因此，集中范围 LP 将其范围之上的所有价格都视为范围顶部的价格，而在范围之下时，价格可以视为底部价格点。

一个可以在程序或电子表格中使用的健壮函数的公式如下：

一个 v3 LP 指定了{流动性，pLow，pHigh}来建立一个范围。与当前价格结合，这意味着一定数量的 USDC、ETH 和特定的 USD 价值。

**标记费用数学**

{2500, 2601}的范围使 LP 有权从该范围内的交易中产生的费用收入中获得一定百分比。需要有一种方法来排除 2500 以下和 2601 以上的交易。执行此操作的会计机制非常巧妙。

每个初始化的标记都被分配了一个状态变量，用于其 ETH 和 USD 费用。当与全局 ETH 和 USD 费用状态结合时，可以推断出生成给 LP 的费用，考虑到它们的下限和上限标记。

标记费用分配规则适用于两个令牌（这里是 ETH 和 USDC）的费用，但我们将重点放在一个令牌上以简化表示。将 globalETHfee 定义为除以其应用时经历的流动性的费用的全局总和（例如，如果用户在流动性为 1000 时支付了 10 美元，则 globalETHfee 将增加 0.01）。

上述方程使得计算 LP 的费用收入变得容易。对于在 j=4 提供流动性的 LP，假设当前 j=n，我们将有

在 v3 中，我们必须排除从 LP 范围外的交易中产生的费用。我们使用以下规则应用于所有标记以跟踪具有各种标记端点的 LP 的相关费用收入。每次越过一个标记时更新六个不同的变量。与标记费用数学相关的，对于每个标记都有一个 ETH 和 USDC 费用参数。请记住，任何 LP 范围都使用这些标记的子集。

+   如果第一次交叉

+   如果再次交叉

    +   newTickFee= globalETHfee - oldtickFee

标记仅在交叉时更新，尽管全局标记费用在每笔交易中递增。当 LP 撤回其流动性时，她的费用状态—将被乘以她的流动性—然后使用她的低和高标记计算，如下所示：

+   如果在范围之上，即 pLast>pHigh

    +   tickFee(pHigh) - tickFee(pLow)

+   如果在范围之下

    +   tickFee(pLow) - tickFee(pHigh)

+   如果在范围内

    +   globalETHfee - tickFee(pLow) - tickFee(pHigh)

附上的工作表展示了如何在 pLow=1900 和 pHigh=2000 的范围内以及费率为 0.3% 的情况下进行操作。在 G:H 列中，我们看到每笔交易的费用，在 I:J 列中，我们看到了费用的全局状态，即累积总和。K:L 列显示了如何在每次交叉时更新 tick 费用状态，对于 1900 tick，而 M:N 列显示了如何更新上方的 tick。这遵循了上述‘tick 费用更新’规则。

S 列和 T 列显示了在各种价格上如何应用‘费用计算’规则——在价格范围内部、上方和下方——使用全局和 tick 费用状态变量。在这个例子中，我计算了 {1900, 2000} 范围内的费用，标记为黄色。请注意，LP 只应该在黄色区域内进行的交易才能获得费用。这种“蛮力”计算方法使用 Excel 的 if 规则来显示逻辑生成与计算黄色区域内所有费用相同的结果（这些费用在 g:h 列中）。

该池总共产生了 281.34 美元的 USDC 和 0.097 个 ETH，最终，其中 162.25 美元的 USDC 和 0.086 个 ETH 归 LP 从 1900 到 2000 提供流动性。
